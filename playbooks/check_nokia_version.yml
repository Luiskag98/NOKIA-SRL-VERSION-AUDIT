---
- name: Nokia SR Linux - Software Version Audit
  hosts: all
  gather_facts: no
  vars:
    ansible_connection: network_cli
  tasks:
    - name: Show version
      ansible.netcommon.cli_command:
        command: show version
      register: show_version
      ignore_errors: yes

    - name: Fallback - show system information when show version fails
      ansible.netcommon.cli_command:
        command: show system information
      when: show_version is failed
      register: show_system_info
      ignore_errors: yes

    - name: Determine version string
      set_fact:
        srl_version: >-
          {{ (show_version.stdout if (show_version is defined and (show_version.rc is not defined or show_version.rc == 0)) else (show_system_info.stdout | default(''))) | trim }}

    - name: Publish version per host
      set_stats:
        data:
          versions: {"{{ inventory_hostname }}": "{{ srl_version | default('') }}"}
        aggregate: yes

    - name: Debug version
      debug:
        msg: "{{ inventory_hostname }} -> {{ srl_version | default('unknown') }}"
